<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
  <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="assets/css/ace.min.css" />
  <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
  <link rel="stylesheet" href="Widget/zTree/css/zTreeStyle/zTreeStyle.css" type="text/css">
  <link href="Widget/icheck/icheck.css" rel="stylesheet" type="text/css" />
  <!--[if IE 7]>
    <link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css" />
  <![endif]-->
      <!--[if lte IE 8]>
    <link rel="stylesheet" href="assets/css/ace-ie.min.css" />
  <![endif]-->
  <script src="js/jquery-1.9.1.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/js/typeahead-bs2.min.js"></script>
  <!-- page specific plugin scripts -->
  <script src="assets/js/jquery.dataTables.min.js"></script>
  <script src="assets/js/jquery.dataTables.bootstrap.js"></script>
  <script type="text/javascript" src="js/H-ui.js"></script>
  <script type="text/javascript" src="js/H-ui.admin.js"></script>
  <script src="assets/layer/layer.js" type="text/javascript" ></script>
  <script src="assets/laydate/laydate.js" type="text/javascript"></script>
  <script type="text/javascript" src="Widget/zTree/js/jquery.ztree.all-3.5.min.js"></script>
  <script src="js/lrtk.js" type="text/javascript" ></script>
  <title>转售订单管理</title>
  <style>
    .layerBox{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    .layerBox.hide{
      display: none;
    }
    .changePrice{
      position: absolute;
      width: 400px;
      height: 200px;
      top: 50%;
      left: 50%;
      margin-left: -200px;
      margin-top: -100px;
      background: #fff;
    }
    .changePrice h3{
      text-align: center;
      padding: 20px 20px 50px;
    }
    .changePrice input.changeInput{
      width: 200px;
      height: 35px;
      margin-right: 20px;
      margin-left: 40px;
    }
    .changePrice .changePriceBtn{
      width: 80px;
      height: 35px;
      line-height: 20px;
    }
  </style>
</head>
<body>
<div class="layerBox hide">
  <div class="changePrice">
    <h3>修改预估价格</h3>
    <input class="changeInput" type="number" name="" placeholder="填写预估价格">
    <a href="javascript:;"  class="btn btn-xs btn-primary changePriceBtn" data-orderNo=''>确认</a>
  </div>
</div>
<div class="page-content clearfix">
 <div id="products_style">
    <div class="search_style">
      <div class="title_names">搜索查询</div>
      <ul class="search_content clearfix">
       <li><label class="l_f">商品品牌</label><input name="" type="text" placeholder="输入品牌名称"  style=" width:150px"/></li>
       <li><label class="l_f">创建时间</label><input class="inline laydate-icon" id="start" style=" margin-left:10px;"></li>
       <li><label class="l_f">至</label><input class="inline laydate-icon" id="end" style=" margin-left:10px;"></li>
       <li><label class="l_f">订单号</label><input name="" type="text" placeholder="输入订单号"  style=" width:200px"/></li>
       <li>
         <label class="l_f" style="margin-right: 10px;">型号</label>
         <select name="" id="goodType">
            <option value="9">全部</option>
            <option value="0">6</option>
            <option value="1">6 plus</option>
            <option value="2">6s</option>
            <option value="3">6s plus</option>
            <option value="4">7</option>
            <option value="5">7 plus</option>
            <option value="6">8</option>
            <option value="7">8 plus</option>
            <option value="8">X</option>
          </select>
       </li>
       <li>
         <label class="l_f" style="margin-right: 10px;">订单状态 </label>
         <select name="" id="orderStatus">
            <option value="0">全部</option>
            <option value="1">待提货</option>
            <option value="2">已提货</option>
            <option value="3">交易完成</option>
          </select>
       </li>
       <li>
         <label class="l_f" style="margin-right: 10px;">用户操作行为 </label>
         <select name="" id="userOeration">
            <option value="0">全部</option>
            <option value="1">用户未确认提货</option>
            <option value="2">用户已确认提货</option>
            <option value="3">用户未确认成交</option>
            <option value="4">用户已确认成交</option>
          </select>
       </li>
       <li style="width:90px;"><button type="button" class="btn_search"><i class="icon-search"></i>查询</button></li>
      </ul>
    </div>
    <table class="table table-striped table-bordered table-hover" id="sample-table">
      <thead>
        <tr>
          <tr>
            <th width="120px">订单编号</th>
            <th width="80px">商品名称</th>
            <th width="80px">型号</th>
            <th width="180px">商品属性</th>
            <th width="80px">单价</th>
            <th width="50px">数量</th>
            <th width="80px">总价</th>
            <th width="80px">提货方式</th>
            <th width="100px">转售预估价格</th>
            <th width="100px">转售实际报价</th>
            <th width="150px">购买时间</th>
            <th width="150px">转售时间</th>
            <th width="150px">订单状态</th>
            <th width="100px">转售状态</th>
            <th width="120px">用户操作行为</th>
            <th width="350px">操作</th>
          </tr>
        </tr>
      </thead>
      <tbody style="text-align: center;" id="orderListTbody">
      </tbody>
    </table>
 </div>
</div>
</body>
</html>
<script>
Date.prototype.format = function(format){
  var date = {
    "M+": this.getMonth() + 1,
    "d+": this.getDate(),
    "h+": this.getHours(),
    "m+": this.getMinutes(),
    "s+": this.getSeconds(),
    "q+": Math.floor((this.getMonth() + 3) / 3),
    "S+": this.getMilliseconds()
  };
  if (/(y+)/i.test(format)) {
    format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
  }
  for (var k in date) {
    if (new RegExp("(" + k + ")").test(format)) {
      format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
    }
  }
 return format;
}
$(function() {
  $("#products_style").fix({
    float : 'left',
    //minStatue : true,
    skin : 'green',
    durationTime :false,
    spacingw:30,//设置隐藏时的距离
    spacingh:260,//设置显示时间距
  });
});
$(function(){
  var apiurl = 'http://m.bjysshop.com';
  loadOrder();

  function loadOrder(){
    $.ajax({
      url: apiurl + '/admin/order/list',
      type: 'GET',
      data: {
        pageSize: 100000,
        orderType: 1
      },
      dataType: 'json',
      crossDomain: true,
      success: function(res){
        var orderList = res.data.list, allDOM = '';
        $(orderList).each(function(index, item){
          var pickWayDeac = '', orderStatusDesc = '', reSellOrderStatusDesc = '', userOperationDesc = '', operationDom = '';
          switch(item.order.pickUpWay){
            case 0:pickWayDeac = '送货上门';break;
            case 1:pickWayDeac = '邮寄';break;
          }

          if(item.order.shopConfirmStatus != 3){
            switch(item.order.resaleStatus){
              case 0:
                orderStatusDesc = '转售中';
                reSellOrderStatusDesc='待送货上门';
                userOperationDesc = '用户未送货上门';
                operationDom = '<a href="javascript:;"  class="btn btn-xs btn-info conifrmRecivice" >用户确认已送货</a><a href="javascript:;"  class="btn btn-xs btn-warning cancleOrder" >取消订单</a>';
              break;
              case 1:
                orderStatusDesc = '转售中';
                reSellOrderStatusDesc='待质检';
                userOperationDesc = '用户已送货上门';
                operationDom = '<a href="javascript:;"  class="btn btn-xs btn-primary qualityBtn" >质检通过</a><a href="javascript:;"  class="btn btn-xs btn-warning amendPrice" >修改转售价格</a><a href="javascript:;"  class="btn btn-xs btn-warning cancleOrder" >取消订单</a>';
              break;
              case 2:
                orderStatusDesc = '转售中';
                reSellOrderStatusDesc='质检完';
                userOperationDesc = '用户未确认成交';
                operationDom = '<a href="javascript:;"  class="btn btn-xs btn-warning cancleOrder" >取消订单</a>';
              break;
              default:
                orderStatusDesc = '已转售';
                reSellOrderStatusDesc='转售完成';
                userOperationDesc = '用户已确认成交';
                operationDom = '<a href="javascript:;"  class="btn btn-xs btn-warning cancleOrder" >取消订单</a>';
              break;
            }
          } else {
            orderStatusDesc = '已取消';
            operationDom = '无';
            switch(item.order.resaleStatus){
              case 0:reSellOrderStatusDesc='待送货上门';userOperationDesc = '用户未送货上门';break;
              case 1:reSellOrderStatusDesc='待质检';userOperationDesc = '用户已送货上门';break;
              case 2:reSellOrderStatusDesc='质检完';userOperationDesc = '用户未确认成交';break;
              default:reSellOrderStatusDesc='转售完成';userOperationDesc = '用户已确认成交';break;
            }
          }

          var trDOM = '<tr>' +
              '<td width="120px">' + item.order.orderNo + '</td>' +
              '<td width="80px">' + item.name + '</td>' +
              '<td width="80px">' + item.subName + '</td>' +
              '<td width="180px">' + item.desc + '</td>' +
              '<td width="80px">' + item.originUnitPrice + '</td>' +
              '<td width="50px">' + item.order.needCount + '</td>' +
              '<td width="80px">' + item.originTotalMoney + '</td>' +
              '<td width="80px">' + pickWayDeac + '</td>' +
              '<td width="100px">' + item.order.estimatedPrice + '</td>' +
              '<td width="100px">' + item.order.actualPrice + '</td>' +
              '<td width="150px">' + new Date(item.originBuyTime).format('yyyy-MM-dd hh:mm:ss') + '</td>' +
              '<td width="150px">' + new Date(item.order.createTime).format('yyyy-MM-dd hh:mm:ss') + '</td>' +
              '<td width="150px">' + orderStatusDesc + '</td>' +
              '<td width="100px">' + reSellOrderStatusDesc + '</td>' +
              '<td width="120px">' + userOperationDesc + '</td>' +
              '<td width="350px" class="td-manage" data-id=' + item.order.orderNo +'>' + operationDom +
              '</td>' +
            '</tr>';
          allDOM += trDOM;
        })
        $('#orderListTbody').html(allDOM);
        renderPlug()
      }
    })
  }

  function bindEvents() {
    $('#orderListTbody').find('.cancleOrder').on('click', function(){
      var orderNo = $(this).parents('.td-manage').attr('data-id');
      layer.confirm('确认取消订单',function(index){
        handleCancle(orderNo, function(res){
          if(res.code != 0){
            layer.msg(res.msg,{icon: 5,time:1500});
            return;
          }
          layer.msg('已取消!',{icon: 5,time:1000});
          setTimeout(function(){
            window.location.reload();
          }, 1000)
        })
      });
    })
    $('#orderListTbody').find('.conifrmRecivice').on('click', function(){
      var orderNo = $(this).parents('.td-manage').attr('data-id');
      layer.confirm('确认用户已经送货上门',function(index){
        resalepickup(orderNo, function(res){
          if(res.code != 0){
            layer.msg(res.msg,{icon: 5,time:1500});
            return;
          }
          layer.msg('已确认用户已经送货上门!',{icon: 5,time:1000});
          setTimeout(function(){
            window.location.reload();
          }, 1000)
        })
      });
    })
    $('#orderListTbody').find('.amendPrice').on('click', function(){
      var orderNo = $(this).parents('.td-manage').attr('data-id');
      $('.layerBox').removeClass('hide').find('.changePriceBtn').attr('data-orderNo', orderNo);
    })
    $('.changePriceBtn').click(function(){
      var orderNo = $(this).attr('data-orderNo');
      var estimatePrice = $(this).prev('.changeInput').val();
      if(estimatePrice == ''){
        layer.msg('价格不能为空',{icon: 5,time:1500});
        return;
      }
      resaleprice(orderNo, estimatePrice, function(res){
        if(res.code != 0){
          layer.msg(res.msg,{icon: 5,time:1500});
          return;
        }
        layer.msg('修改预估价格成功！',{icon: 5,time:1000});
        setTimeout(function(){
          window.location.reload();
        }, 1000)
      })
    })
    $('#orderListTbody').find('.qualityBtn').on('click', function(){
      var orderNo = $(this).parents('.td-manage').attr('data-id');
      layer.confirm('确认质检通过？',function(index){
        quality(orderNo, function(res){
          if(res.code != 0){
            layer.msg(res.msg,{icon: 5,time:1500});
            return;
          }
          setTimeout(function(){
            window.location.reload();
          }, 1000)
        })
      });
    })
    $('.btn_search').click(function(){
       layer.msg('暂时不支持筛选查询，敬请期待！' ,{icon: 5,time:1500});
    })
  }

  // 取消订单
  function handleCancle(orderNo, cb){
    $.ajax({
      url: apiurl + '/admin/order/cancle',
      type: 'POST',
      data: {
        orderNo: orderNo
      },
      dataType: 'json',
      crossDomain: true,
      success: function(res){
        cb(res);
      }
    })
  }
  // 确认送货上门
  function resalepickup(orderNo, cb){
    $.ajax({
      url: apiurl + '/admin/confirm/resalepickup',
      type: 'POST',
      data: {
        orderNo: orderNo
      },
      dataType: 'json',
      crossDomain: true,
      success: function(res){
        cb(res);
      }
    })
  }

  // 修改预估价
  function resaleprice(orderNo, resalePrice, cb){
    $.ajax({
      url: apiurl + '/admin/alter/resaleprice',
      type: 'POST',
      data: {
        orderNo: orderNo,
        resalePrice: resalePrice
      },
      dataType: 'json',
      crossDomain: true,
      success: function(res){
        cb(res);
      }
    })
  }
  // 质检接口
  function quality(orderNo, cb){
    $.ajax({
      url: apiurl + '/admin/quality/complete',
      type: 'POST',
      data: {
        orderNo: orderNo
      },
      dataType: 'json',
      crossDomain: true,
      success: function(res){
        cb(res);
      }
    })
  }

  function renderPlug(){
    var oTable1 = $('#sample-table').dataTable({
      "aLengthMenu":[10,20,30],
      "aaSorting": [[ 0, "desc" ]],//默认第几个排序
      "bStateSave": true,//状态保存
      "aoColumnDefs": [
        {"orderable":false,"aTargets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]}// 制定列不参与排序
      ],
      "fnDrawCallback": function(){
        bindEvents();
      }
    });
    $('[data-rel="tooltip"]').tooltip({placement: tooltip_placement});
    function tooltip_placement(context, source) {
      var $source = $(source);
      var $parent = $source.closest('table')
      var off1 = $parent.offset();
      var w1 = $parent.width();
      var off2 = $source.offset();
      var w2 = $source.width();
      if( parseInt(off2.left) < parseInt(off1.left) + parseInt(w1 / 2) ) return 'right';
      return 'left';
    }
    laydate({
      elem: '#start',
      event: 'focus'
    });
    laydate({
      elem: '#end',
      event: 'focus'
    });
  }
})
</script>
<script type="text/javascript">
  //初始化宽度、高度
  $(".widget-box").height($(window).height()-215);
  $(".table_menu_list").width($(window).width()-260);
  $(".table_menu_list").height($(window).height()-215);
  //当文档窗口发生改变时 触发
  $(window).resize(function(){
    $(".widget-box").height($(window).height()-215);
    $(".table_menu_list").width($(window).width()-260);
    $(".table_menu_list").height($(window).height()-215);
  })
  //面包屑返回值
  $('.Order_form').on('click', function(){
    var cname = $(this).attr("title");
    var chref = $(this).attr("href");
    var cnames = parent.$('.Current_page').html();
    var herf = parent.$("#iframe").attr("src");
      parent.$('#parentIframe').html(cname);
      parent.$('#iframe').attr("src",chref).ready();;
    parent.$('#parentIframe').css("display","inline-block");
    parent.$('.Current_page').attr({"name":herf,"href":"javascript:void(0)"}).css({"color":"#4c8fbd","cursor":"pointer"});
    //parent.$('.Current_page').html("<a href='javascript:void(0)' name="+herf+" class='iframeurl'>" + cnames + "</a>");
      parent.layer.close(index);
  });
</script>